<div class="container">
  <header>
    <h1>ğŸ™ï¸ Kani's Audio Transcriber</h1>
    <p class="subtitle">Upload a file and get it transcribed using AWS Transcribe</p>
  </header>

  <main class="main-content">
    <div class="columns-layout" [class.has-summary]="hasSummary || isGeneratingSummary || summaryError">
      <!-- Column 1: Upload Form -->
      <div class="column column-upload">
        <div class="upload-section">
      <div class="file-input-wrapper">
        <input 
          type="file" 
          id="audioFile" 
          (change)="onFileSelected($event)"
          class="file-input"
        />
        <label for="audioFile" class="file-label">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          <span>{{ selectedFile ? selectedFile.name : 'Choose File' }}</span>
        </label>
      </div>

      <div *ngIf="selectedFile" class="file-info">
        <p><strong>File:</strong> {{ selectedFile.name }}</p>
        <p><strong>Size:</strong> {{ formatFileSize(selectedFile.size) }}</p>
        <p><strong>Type:</strong> {{ selectedFile.type || 'Unknown' }}</p>
      </div>

      <button 
        class="transcribe-button"
        (click)="showConfirmationModal()"
        [disabled]="!selectedFile || isUploading || isTranscribing"
      >
        <span *ngIf="!isUploading && !isTranscribing">ğŸš€ Upload & Transcribe</span>
        <span *ngIf="isUploading || isTranscribing">â³ Processing...</span>
      </button>

          <button 
            class="saved-jobs-button"
            (click)="showSavedJobs = !showSavedJobs"
            *ngIf="savedJobs.length > 0"
          >
            ğŸ“š Saved Jobs ({{ savedJobs.length }})
          </button>

          <div *ngIf="isUploading || isTranscribing" class="progress-section">
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="uploadProgress"></div>
            </div>
            <p class="status-text">{{ transcriptionStatus }}</p>
          </div>

          <div *ngIf="errorMessage" class="error-message">
            <strong>âŒ Error:</strong> {{ errorMessage }}
          </div>
        </div>
      </div>
      <!-- End Column 1 -->

      <!-- Column 2: Chat Conversation Transcript -->
      <div class="column column-transcript" *ngIf="transcriptionResult || speakerSegments.length > 0">
        <div class="result-section">
          <div class="result-header">
            <h2>ğŸ“ Transcription Result</h2>
            <div class="header-actions">
              <div class="view-toggle" *ngIf="speakerSegments.length > 0">
                <button 
                  class="toggle-btn" 
                  [class.active]="showSpeakerView"
                  (click)="showSpeakerView = true"
                >
                  ğŸ‘¥ By Speaker
                </button>
                <button 
                  class="toggle-btn" 
                  [class.active]="!showSpeakerView"
                  (click)="showSpeakerView = false"
                >
                  ğŸ“„ Full Text
                </button>
              </div>
              <button 
                class="generate-summary-btn-header"
                (click)="generateSummary()"
                [disabled]="isGeneratingSummary || (!transcriptionResult && speakerSegments.length === 0)"
                [class.loading]="isGeneratingSummary"
                title="Generate AI Summary"
              >
                <span *ngIf="!isGeneratingSummary && !summary" class="btn-content">
                  <span class="btn-icon">âœ¨</span>
                  <span>AI Summary</span>
                </span>
                <span *ngIf="isGeneratingSummary" class="btn-content">
                  <span class="btn-spinner"></span>
                  <span>Generating...</span>
                </span>
                <span *ngIf="!isGeneratingSummary && summary" class="btn-content">
                  <span class="btn-icon">âœ¨</span>
                  <span>Regenerate</span>
                </span>
              </button>
            </div>
          </div>

      <!-- Speaker-segmented view - Chat Style -->
          <div *ngIf="showSpeakerView && speakerSegments.length > 0" class="chat-container">
        <!-- Speaker Name Editor Section - Compact -->
        <div class="speaker-names-section-compact" *ngIf="getUniqueSpeakers().length > 0">
          <div class="speaker-names-list-compact">
            <div *ngFor="let speaker of getUniqueSpeakers()" class="speaker-name-item-compact">
              <span class="speaker-color-indicator" [style.background-color]="getSpeakerColor(speaker)"></span>
              <div *ngIf="editingSpeaker !== speaker" class="speaker-name-display-compact">
                <span class="speaker-label-compact">{{ formatSpeakerName(speaker) }}</span>
                <button class="edit-name-btn-compact" (click)="startEditingSpeaker(speaker, $event)" title="Edit name">
                  âœï¸
                </button>
              </div>
              <div *ngIf="editingSpeaker === speaker" class="speaker-name-edit-compact">
                <input 
                  type="text" 
                  [(ngModel)]="editingSpeakerName"
                  (keyup.enter)="saveSpeakerName(speaker)"
                  (keyup.escape)="cancelEditingSpeaker()"
                  class="speaker-name-input-compact"
                  placeholder="Enter name"
                  #nameInput
                  (focus)="nameInput.select()"
                />
                <button class="save-name-btn-compact" (click)="saveSpeakerName(speaker)">âœ“</button>
                <button class="cancel-name-btn-compact" (click)="cancelEditingSpeaker()">âœ•</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages">
          <div 
            *ngFor="let segment of speakerSegments; let i = index" 
            class="chat-message-wrapper"
            [class.message-left]="isSpeakerLeft(segment.speaker)"
            [class.message-right]="!isSpeakerLeft(segment.speaker)"
            [attr.data-segment-index]="i"
          >
            <div 
              class="chat-message"
              [style.background-color]="isSpeakerLeft(segment.speaker) ? '#ffffff' : getSpeakerColor(segment.speaker)"
              [style.color]="isSpeakerLeft(segment.speaker) ? '#333' : '#ffffff'"
            >
              <div class="message-header">
                <span class="message-sender">{{ formatSpeakerName(segment.speaker) }}</span>
                <span class="message-time">{{ formatTime(segment.startTime) }}</span>
              </div>
              <div 
                class="message-text"
              >{{ segment.text }}</div>
            </div>
          </div>
        </div>
      </div>

          <!-- Full text view -->
          <div *ngIf="!showSpeakerView || speakerSegments.length === 0" class="transcription-box">
            <p>{{ transcriptionResult }}</p>
          </div>

          <button class="copy-button" (click)="copyToClipboard()">ğŸ“‹ Copy to Clipboard</button>
        </div>
      </div>
      <!-- End Column 2 -->

      <!-- Column 3: Summary -->
      <div class="column column-summary" *ngIf="transcriptionResult || speakerSegments.length > 0">
        <div class="summary-section">
          <div class="summary-header">
          <div class="summary-title-group">
            <div class="summary-icon">ğŸ“Š</div>
            <div>
              <h3>Conversation Summary</h3>
              <p class="summary-subtitle">AI-powered insights from your transcription</p>
            </div>
          </div>
          </div>

          <div *ngIf="isGeneratingSummary" class="summary-loading">
          <div class="loading-container">
            <div class="loading-spinner-large"></div>
            <div class="loading-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <p class="loading-text">Analyzing conversation with AI...</p>
          </div>
          </div>

          <div *ngIf="summaryError" class="summary-error">
          <div class="error-icon">âš ï¸</div>
          <div class="error-content">
            <strong>Error generating summary</strong>
            <p>{{ summaryError }}</p>
          </div>
          </div>

          <div *ngIf="summary && !isGeneratingSummary" class="summary-content">
          <div class="summary-text-wrapper">
            <div class="summary-text" [innerHTML]="formatSummaryText(summary)"></div>
          </div>
          <div class="summary-actions">
            <button class="copy-summary-btn" (click)="copySummaryToClipboard()">
              <span class="btn-icon">ğŸ“‹</span>
              <span>Copy Summary</span>
            </button>
          </div>
          </div>

          <div *ngIf="!summary && !isGeneratingSummary && !summaryError" class="summary-placeholder">
            <div class="placeholder-icon">ğŸ’¡</div>
            <p class="placeholder-text">Click "Generate Summary" to create an AI-powered summary of this conversation.</p>
            <p class="placeholder-hint">Get key insights, main topics, and important points in seconds.</p>
          </div>
        </div>
      </div>
      <!-- End Column 3 -->
    </div>
    <!-- End Columns Layout -->
  </main>

  <!-- <footer class="info-section">
    <h3>â„¹ï¸ Setup Instructions</h3>
    <ol>
      <li>Configure AWS credentials in <code>aws-config.service.ts</code></li>
      <li>Set up an S3 bucket and update the bucket name</li>
      <li>Ensure your AWS credentials have permissions for S3 and Transcribe</li>
      <li>For production, use AWS Cognito Identity Pool for secure credential management</li>
    </ol>
  </footer> -->

  <!-- Saved Jobs Modal -->
  <div *ngIf="showSavedJobs" class="saved-jobs-modal-overlay" (click)="showSavedJobs = false">
    <div class="saved-jobs-modal-content" (click)="$event.stopPropagation()">
      <div class="saved-jobs-header">
        <div class="saved-jobs-title">
          <span class="saved-jobs-icon">ğŸ“š</span>
          <h3>Saved Jobs</h3>
          <span class="saved-jobs-count">({{ savedJobs.length }})</span>
        </div>
        <button class="close-btn" (click)="showSavedJobs = false" title="Close">âœ•</button>
      </div>
      <div class="jobs-list">
        <div *ngFor="let job of savedJobs" class="job-item">
          <div class="job-info" (click)="retrieveJob(job)">
            <span class="job-status">{{ getJobStatusIcon(job.status) }}</span>
            <div class="job-details">
              <p class="job-file-name">{{ job.fileName }}</p>
              <p class="job-meta">
                <span class="job-meta-item">{{ formatFileSize(job.fileSize) }}</span>
                <span class="job-meta-separator">â€¢</span>
                <span class="job-meta-item">{{ formatDate(job.startTime) }}</span>
              </p>
            </div>
          </div>
          <button 
            class="delete-job-btn" 
            (click)="deleteJob(job.jobName); $event.stopPropagation()"
            title="Delete job"
          >
            ğŸ—‘ï¸
          </button>
        </div>
        <div *ngIf="savedJobs.length === 0" class="no-jobs-message">
          <p>No saved jobs yet. Your transcription jobs will appear here.</p>
        </div>
      </div>
    </div>
  </div>
</div>
